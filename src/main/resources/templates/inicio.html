<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Tienda MISH</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}" href="/css/styles.css">
</head>

<body class="inicio-page">
  <header class="header-bar">
    <div class="header-left">
      <a th:href="@{/perfil}" class="profile-link">
        <div class="profile-pic">P</div> <span class="header-username" style="margin-left: 5px; font-weight: bold;">
          <span th:if="${#authorization.expression('isAuthenticated()')}" th:text="${#authentication.name}">
            NombreUsuario
          </span>
          <span th:unless="${#authorization.expression('isAuthenticated()')}">
            Perfil
          </span>
        </span>
      </a>
    </div>

    <div class="search-bar">
      <input type="search" class="search-input" placeholder="Buscar">
    </div>

    <div class="header-right">
      <a th:href="@{/inbox}" class="icon-button inbox-icon">
        &#9993;
      </a>

      <a th:href="@{/settings}" class="icon-button">
        &nbsp; </a>
    </div>
  </header>

  <div class="container">
    <h1>Opciones</h1>
    <ul class="product-list">
      <li th:each="producto : ${productos}" class="product-item">
        <div class="product-image-container">
          <img th:if="${producto.imagenUrl != null and !producto.imagenUrl.isEmpty()}" th:src="@{${producto.imagenUrl}}"
            alt="Imagen del producto" class="product-image">
          <div th:unless="${producto.imagenUrl != null and !producto.imagenUrl.isEmpty()}"
            class="product-image-placeholder">
            IMAGEN
          </div>
        </div>
        <div class="product-name" th:text="${producto.nombre}">
          NOMBRE DE PRODUCTO
        </div>
        <div class="product-price" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 0, 'POINT', 0, 'COMMA')}">
          $1000
        </div>
        <div class="product-publisher" th:if="${producto.publisherUsername != null}"
          th:text="'Publicado por: ' + ${producto.publisherUsername}"
          style="font-size: 0.8em; color: gray; margin-top: 5px;">
          Publicado por: Usuario
        </div>
        <a th:href="@{'/product/' + ${producto.idProducto}}"
          onclick="window.open(this.href, 'productDetails', 'width=900,height=700,scrollbars=yes'); return false;"
          style="color: blue; font-size: 0.8em; margin-top: 5px; display: inline-block; text-decoration: none; border-bottom: 1px dotted blue; cursor: pointer;">
          Ver Detalle
        </a>
      </li>
    </ul>
  </div>
  <div id="productModal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal()">&times;</span>
      <h2>Publicar Nuevo Producto</h2>

      <form th:action="@{/products/add}" method="post" enctype="multipart/form-data">
        <div class="form-group">
          <label for="nombre">Nombre del Producto:</label>
          <input type="text" id="nombre" name="nombre" required>
        </div>
        <div class="form-group">
          <label for="descripcion">Descripción:</label>
          <textarea id="descripcion" name="descripcion" required></textarea>
        </div>
        <div class="form-group">
          <label for="precio">Precio ($):</label>
          <input type="number" id="precio" name="precio" min="1" step="1" placeholder="Ej: 10000" required>
        </div>
        <div class="form-group">
          <label for="cantidad">Cantidad:</label>
          <input type="number" id="cantidad" name="cantidad" min="1" step="1" required>
        </div>
        <div class="form-group">
          <label for="estado">Estado:</label>
          <select id="estado" name="estado" required>
            <option value="Nuevo">Nuevo</option>
            <option value="Seminuevo">Seminuevo</option>
            <option value="Usado">Usado</option>
          </select>
        </div>
        <div class="form-group">
          <label>Imagen del Producto:</label>
          <div class="drop-zone">
            <span class="drop-zone__prompt">Arrastra el archivo aquí o haz clic para subir</span>
            <input type="file" name="imagen" class="drop-zone__input" required>
          </div>
        </div>

        <button type="submit" class="submit-button">Guardar Producto</button>
      </form>
    </div>
  </div>
  <a href="#" onclick="openModal(); return false;" class="floating-action-button">
    <span class="fab-icon">+</span>
  </a>
  <script>
    var modal = document.getElementById("productModal");
    function openModal() {
      modal.style.display = "block";
    }
    function closeModal() {
      modal.style.display = "none";
    }
    window.onclick = function (event) {
      if (event.target == modal) {
        closeModal();
      }
    }

    document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
      const dropZoneElement = inputElement.closest(".drop-zone");

      dropZoneElement.addEventListener("click", (e) => {
        inputElement.click();
      });

      inputElement.addEventListener("change", (e) => {
        if (inputElement.files.length) {
          updateThumbnail(dropZoneElement, inputElement.files[0]);
        }
      });

      dropZoneElement.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZoneElement.classList.add("drop-zone--over");
      });

      ["dragleave", "dragend"].forEach((type) => {
        dropZoneElement.addEventListener(type, (e) => {
          dropZoneElement.classList.remove("drop-zone--over");
        });
      });

      dropZoneElement.addEventListener("drop", (e) => {
        e.preventDefault();

        if (e.dataTransfer.files.length) {
          inputElement.files = e.dataTransfer.files;
          updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
        }

        dropZoneElement.classList.remove("drop-zone--over");
      });
    });

    function updateThumbnail(dropZoneElement, file) {
      let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

      // First time - remove the prompt
      if (dropZoneElement.querySelector(".drop-zone__prompt")) {
        dropZoneElement.querySelector(".drop-zone__prompt").remove();
      }

      // First time - there is no thumbnail element, so lets create it
      if (!thumbnailElement) {
        thumbnailElement = document.createElement("div");
        thumbnailElement.classList.add("drop-zone__thumb");
        dropZoneElement.appendChild(thumbnailElement);
      }

      thumbnailElement.dataset.label = file.name;

      // Show thumbnail for image files
      if (file.type.startsWith("image/")) {
        const reader = new FileReader();

        reader.readAsDataURL(file);
        reader.onload = () => {
          thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
        };
      } else {
        thumbnailElement.style.backgroundImage = null;
      }
    }
  </script>
</body>

</html>